\section{Proposed solutions}
\label{sec:proposed}

\subsection{Avoiding the undefined behavior}

This paper proposes to avoid the undefined behavior by clarifying the semantics of every
build mode in regards of both evaluation of conditions and assumption of those
conditions. For assumption of conditions the clarification needs to address the
case where continuation is disabled and when the continuation is enables.

To define such semantics, the following simple principles are proposed to be followed:

\begin{itemize}

\item A contract that, in a given build mode, is not evaluated cannot be used
for any kind of assumption. This leads to modes where only contracts that have
been checked are used for assumptions and avoiding in this way the identified
paths towards undefined behavior.

\item Moreover, contracts that have been checked can only be assumed if the
continuation mode has been disabled. Otherwise, such assumptions cannot be made.
Note, that no special provision is needed as the application of general rules
of conditional statements would derive this behavior as illustrated in previous
sections.

\item Axiom contract are considered as if they had been evaluated when they are
	enabled. Otherwise, they are ignored.  Note that in any case, they need
		to have a valid syntax, although expressions in an axiom are
		allowed to contain invocations to declared but not defined
		functions. If an axiom contains any invocation that is declared
		but not defined the axiom is ignored.

\end{itemize}

Below, the exact semantics of each build level are identified when 
they are applied
to each contract level.

\subsubsection{Build mode}

The build mode can be any of the following four: \textmark{off}, \textmark{minimal}, 
\textmark{default}, 
\textmark{audit}. This build level affeccts which checks are evaluated at run-time.

\vspace{1em}

\begin{tabular}{|l|c|c|c|c|}
\hline
\emph{contract-level} & \multicolumn{4}{c|}{Build mode}\\
\cline{2-5}
& \textmark{off} & \textmark{minimal} & \textmark{default} & \textmark{audit} \\
\hline
\hline
	\cppid{axiom} & not checked & not checked & not checked & not checked\\
\hline
	\cppid{audit} & not checked & not checked& not checked & checked\\
\hline
	\cppid{default} & not checked & not checked & checked & checked\\
\hline
	\cppid{continue} & not checked & checked & checked & checked\\
\hline
\end{tabular}

\vspace{1em}

Note, that only \cppid{audit}, \cppid{default} and \cppid{continue} checks are affected
by the build mode.

\subsubsection{Continuation mode}

The continuation mode can be either \textmark{off} or \textmark{on}.
Note that the generated code for contracts check might be different depending
on the continuation mode. It is also important to remark that the continuation
mode does not affect to \cppkey{continue} checks.

\begin{itemize}

  \item When the continuation mode is \cppid{off} an implementation is
        allowed to assume that an invocation to the violation handler
	generated from a \cppkey{default} or \cppkey{audit} contract will not
	return. This information may be used to generate code accordingly.
	In this case, an invocation to a returning violation handler results
	in a call to \cppid{std::terminate} after executing the violation 
	handler.

  \item When the continuation mode is \cppid{on} an implementation is 
        not allowed to perform such assumption, which will result in
        different code generation.

  \item In any case, for \cppkey{continue} contract implementations are not
        allowed to assume that a contract check will not return.

\end{itemize}

\subsection{Allowing assumption of axioms}

This paper proposes that an axiom mode is added. The axiom mode can be either
\textmark{off} or \textmark{on}.

\begin{itemize}
  \item When the axiom mode is \textmark{off} an implementation is not
        allowed to make any assumption.
  \item When the axiom mode is \textmark{on} an implementation is
        allowed to assume the axiom.
\end{itemize}

Note that when axiom mode is \textmark{on}, an axiom condition establishes
an assumption barrier. That assumption barrier prevents that the condition
is not backwards propagated.

\subsection{Summary of semantics}

In this section a summary of the build options and their semantics is presented.

The translation is controlled by the following options:

\begin{itemize}
  \item Build mode: \cppid{off}, \cppid{minimal}, \cppid{default}, and \cppid{audit}.
  \item Axiom mode: \cppid{off}, \cppid{on}.
  \item Continuation mode: \cppid{off}, \cppid{on}.
\end{itemize}

\begin{enumerate}

\item Build-mode=\cppid{off}, Axiom-mode=\cppid{off}, continuation=\cppid{off|on}.
\begin{itemize}
  \item No check is performed.
  \item No assumption is made.
\end{itemize}

\item Build-mode=\cppid{off}, Axiom-mode=\cppid{on}, continuation=\cppid{off|on}.
\begin{itemize}
  \item No check is performed.
  \item Checks with \cppkey{axiom} level are assumed.
\end{itemize}

\item Build-level=\cppid{minimal}, Axiom-mode=\cppid{off}, continuation=\cppid{off|on}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} are neither performed nor assumed
  \item Checks with \cppkey{audit} are neither performed nor assumed.
  \item Code for a \cppkey{continue} contract check assumes that violation handler
	  may return.
  \item No \cppkey{axiom} is assumed.
\end{itemize}

\item Build-level=\cppid{minimal}, Axiom-mode=\cppid{on}, continuation=\cppid{off|on}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} are neither performed nor assumed
  \item Checks with \cppkey{audit} are neither performed nor assumed.
  \item Code for a \cppkey{continue} contract check assumes that violation handler
	  may return.
  \item Checks with \cppkey{axiom} level are assumed.
\end{itemize}

\item Build-level=\cppid{default}, Axiom-mode=\cppid{off}, continuation=\cppid{off}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} level are evaluated and assumed.
  \item Checks with \cppkey{audit} are neither performed nor assumed.
  \item Code for \cppkey{default} contract checks 
	  assumes that the violation handler does not return.
  \item Code for \cppkey{continue} contract check assumes that violation handler
	  may return.
  \item No \cppkey{axiom} is assumed.
\end{itemize}

\item Build-level=\cppid{default}, Axiom-mode=\cppid{on}, continuation=\cppid{off}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} level are evaluated and assumed.
  \item Checks with \cppkey{audit} are neither performed nor assumed.
  \item Code for \cppkey{default} contract checks 
	  assumes that the violation handler does not return.
  \item Code for \cppkey{continue} contract check assumes that violation handler
	  may return.
  \item Checks with \cppkey{axiom} level are assumed.
\end{itemize}

\item Build-level=\cppid{default}, Axiom-mode=\cppid{off}, continuation=\cppid{on}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} level are evaluated but not assumed.
  \item Checks with \cppkey{audit} are neither performed nor assumed.
  \item Code for \cppkey{continue} and \cppkey{default} contract check assumes 
	  that violation handler may return.
  \item No \cppkey{axiom} is assumed.
\end{itemize}

\item Build-level=\cppid{default}, Axiom-mode=\cppid{on}, continuation=\cppid{on}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} level are evaluated but not assumed.
  \item Checks with \cppkey{audit} are neither performed nor assumed.
  \item Code for \cppkey{continue} and \cppkey{default} contract check assumes 
	  that violation handler may return.
  \item Checks with \cppkey{axiom} level are assumed.
\end{itemize}

\item Build-level=\cppid{audit}, Axiom-mode=\cppid{off}, continuation=\cppid{off}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} level are evaluated and assumed.
  \item Checks with \cppkey{audit} level are evaluated and assumed.
  \item Code for \cppkey{default} and \cppkey{audit} contract checks 
	  assumes that the violation handler does not return.
  \item Code for \cppkey{continue} contract check assumes that violation handler
	  may return.
  \item No \cppkey{axiom} is assumed.
\end{itemize}

\item Build-level=\cppid{audit}, Axiom-mode=\cppid{on}, continuation=\cppid{off}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} level are evaluated and assumed.
  \item Checks with \cppkey{audit} level are evaluated and assumed.
  \item Code for \cppkey{default} and \cppkey{audit} contract checks 
	  assumes that the violation handler does not return.
  \item Code for \cppkey{continue} contract check assumes that violation handler
	  may return.
  \item Checks with \cppkey{axiom} level are assumed.
\end{itemize}

\item Build-level=\cppid{audit}, Axiom-mode=\cppid{off}, continuation=\cppid{on}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} level are evaluated but not assumed.
  \item Checks with \cppkey{audit} level are evaluated but not assumed.
  \item Code for all contract checks assumes that the violation handler may return.
  \item No \cppkey{axiom} is assumed.
\end{itemize}

\item Build-level=\cppid{audit}, Axiom-mode=\cppid{on}, continuation=\cppid{on}
\begin{itemize}
  \item Checks with \cppkey{continue} level are evaluated and assumed.
  \item Checks with \cppkey{default} level are evaluated but not assumed.
  \item Checks with \cppkey{audit} level are evaluated but not assumed.
  \item Code for all contract checks assumes that the violation handler may return.
  \item Checks with \cppkey{axiom} level are assumed.
\end{itemize}

\end{enumerate}
